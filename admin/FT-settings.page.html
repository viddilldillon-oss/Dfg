<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Settings — Supa Dillie-Cious Admin</title>

<style>
    :root{
      --accent:#ffcc00;
      --glass:rgba(0,0,0,.55);
      --glass2:rgba(0,0,0,.35);
      --glow:0 10px 30px rgba(0,0,0,.35);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#fff;
      background:url("assets/supa.png") no-repeat center center fixed;
      background-size:cover;
      position:relative;
      overflow-x:hidden;
    }
    .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45));z-index:0}

    /* ===== SAME HEADER as your dashboard ===== */
    header{
      position:fixed;top:0;left:0;width:100%;z-index:10;
      display:flex;align-items:center;justify-content:center;
      padding:14px 22px;
      background:rgba(0,0,0,.5);backdrop-filter:blur(6px);
      box-shadow:var(--glow);
    }
    header h1{
      position:absolute;left:20px;top:50%;transform:translateY(-50%);
      margin:0;font-size:1.25rem;letter-spacing:.4px;color:var(--accent);
      text-shadow:0 2px 10px rgba(0,0,0,.6);
    }
    .menu-btn{
      font-size:26px;line-height:1;background:transparent;border:2px solid var(--accent);
      color:var(--accent);cursor:pointer;padding:6px 10px;border-radius:10px;
      transition:transform .2s ease, background .2s ease, color .2s ease;
    }
    .menu-btn:hover{transform:scale(1.05);background:var(--accent);color:#000}

    /* Centered dropdown menu (same as dashboard) */
    .menu{
      position:fixed;top:66px;left:50%;transform:translateX(-50%);z-index:12;
      width:230px;padding:10px 0;border-radius:12px;
      background:var(--glass);backdrop-filter:blur(8px);box-shadow:var(--glow);
      display:none;flex-direction:column;overflow:auto;max-height:70vh;
      border:1px solid rgba(255,255,255,.08);
      animation:fadeIn .25s ease;
    }
    .menu.show{display:flex}
    .menu a{
      color:#fff;text-decoration:none;padding:12px 16px;display:block;
      transition:background .2s ease;
    }
    .menu a:hover{background:rgba(255,204,0,.2)}
    .menu hr{border:0;border-top:1px solid rgba(255,255,255,.08);margin:6px 0}

    main{position:relative;z-index:1;max-width:900px;margin:120px auto 40px;padding:0 16px}

    /* Cards, inputs, buttons */
    .card{
      background:var(--glass);backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:20px;box-shadow:var(--glow);
      animation:fadeUp .6s ease both;margin-bottom:20px;
    }
    h2{margin:.2rem 0 1rem;font-size:1.3rem;color:var(--accent)}
    label{display:block;margin-top:12px;font-weight:700}
    input,select,textarea{
      width:100%;padding:10px;margin-top:6px;border:none;border-radius:10px;
      background:rgba(255,255,255,.15);color:#fff;font-size:1rem;outline:none;
      backdrop-filter:blur(3px);transition:background .2s ease;
      box-sizing:border-box;
    }
    input:focus,select:focus,textarea:focus{background:rgba(255,255,255,.25)}
    select option{background:#222;color:#fff}
    .btn{
      display:inline-block;background:var(--accent);color:#000;border:none;border-radius:12px;
      padding:12px 16px;font-weight:900;cursor:pointer;margin-top:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.35);transition:transform .2s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(255,204,0,.45)}

    .settings-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;
    }

    /* Toggle Switch Styles */
    .toggle-group{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 0;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .toggle-group:last-child{border-bottom:none}
    .toggle-group label{margin:0;font-weight:700}
    .toggle-switch{
      position:relative;display:inline-block;width:50px;height:26px;
    }
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{
      position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,.2);transition:.3s;border-radius:26px;
    }
    .toggle-slider:before{
      position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;
      background:#fff;transition:.3s;border-radius:50%;
    }
    input:checked + .toggle-slider{
      background:var(--accent);
    }
    input:checked + .toggle-slider:before{
      transform:translateX(24px);
    }

    /* Export Buttons */
    .export-buttons{
      display:flex;flex-direction:column;gap:12px;
    }
    .export-buttons .btn{
      margin-top:0;text-align:left;display:flex;align-items:center;gap:8px;
    }

    @keyframes fadeUp{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translate(-50%,-8px)}
      to{opacity:1;transform:translate(-50%,0)}
    }
  </style>
  <link rel="stylesheet" href="assets/hover-theme.css">
</head>
<body>
  <div class="overlay"></div>

  <!-- SAME header/burger as your dashboard -->
  <header>
    <h1>Settings</h1>
    <button class="menu-btn" id="menuBtn" aria-label="Open menu">☰</button>
  </header>

  <!-- SAME centered dropdown as your dashboard -->
  <nav class="menu" id="menu">
    <a href="FT-dashboard.page.html">Dashboard</a>
    <a href="FT-products.page.html">Products</a>
    <a href="FT-orders.page.html">Orders</a>
    <a href="FT-sales.page.html">Sales</a>
    <a href="FT-suppliers.page.html">Suppliers</a>
    <hr>
    <a href="FT-settings.page.html" class="active">Settings</a>
    <a href="FT-logout.page.html">Logout</a>
  </nav>

  <main>
    <!-- Settings Cards -->
    <div class="settings-grid">
      <!-- Profile Card -->
      <section class="card">
        <h2>Profile</h2>
        <form id="profileForm">
          <label for="profileEmail">Email</label>
          <input type="email" id="profileEmail" placeholder="you@email.com" />
          
          <label for="displayName">Display Name</label>
          <input type="text" id="displayName" placeholder="Supa Admin" />
          
          <button class="btn" type="submit">Save Profile</button>
        </form>
      </section>

      <!-- Password Card -->
      <section class="card">
        <h2>Password</h2>
        <form id="passwordForm">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password" required />
          
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" placeholder="Enter new password" required />
          
          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" placeholder="Re-enter new password" required />
          
          <button class="btn" type="submit">Update Password</button>
        </form>
      </section>
    </div>

    <!-- Business Info Card -->
    <section class="card">
      <h2>Business Information</h2>
      <form id="businessForm">
        <label for="storeName">Store Name</label>
        <input type="text" id="storeName" placeholder="Supa Dillie-Cious Mart" />
        
        <label for="contactEmail">Contact Email</label>
        <input type="email" id="contactEmail" placeholder="contact@supadilliecious.com" />
        
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" placeholder="(876) 123-4567" />
        
        <label for="address">Address</label>
        <textarea id="address" rows="3" placeholder="123 Main Street, Kingston, Jamaica"></textarea>
        
        <label for="businessHours">Business Hours</label>
        <textarea id="businessHours" rows="3" placeholder="Mon-Fri: 8am - 6pm\nSat: 9am - 4pm\nSun: Closed"></textarea>
        
        <button class="btn" type="submit">Save Business Info</button>
      </form>
    </section>

    <!-- Notification Preferences Card -->
    <section class="card">
      <h2>Notification Preferences</h2>
      <div id="notificationToggles">
        <div class="toggle-group">
          <label>New Order Alerts</label>
          <label class="toggle-switch">
            <input type="checkbox" id="notifyOrders" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-group">
          <label>Low Stock Warnings</label>
          <label class="toggle-switch">
            <input type="checkbox" id="notifyLowStock" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-group">
          <label>New User Sign-ups</label>
          <label class="toggle-switch">
            <input type="checkbox" id="notifyNewUsers" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </section>

    <!-- Data Export Card -->
    <section class="card">
      <h2>Data Export</h2>
      <p style="opacity:.9;margin-bottom:16px">Download your data as CSV files for backup or analysis.</p>
      <div class="export-buttons">
        <button class="btn" id="exportProducts">📥 Export Products CSV</button>
        <button class="btn" id="exportOrders">📥 Export Orders CSV</button>
        <button class="btn" id="exportSales">📥 Export Sales CSV</button>
      </div>
    </section>
  </main>

  <script>
    /* ===== Burger dropdown (same behavior as dashboard) ===== */
    const menuBtn = document.getElementById("menuBtn");
    const menu = document.getElementById("menu");
    menuBtn.addEventListener("click", ()=> menu.classList.toggle("show"));
    document.addEventListener("click", (e)=>{
      if (!menu.contains(e.target) && !menuBtn.contains(e.target)) menu.classList.remove("show");
    });

    /* ===== API helpers ===== */
    const API_ROOT = "http://localhost:5000/api";
    const token = localStorage.getItem("token");

    // Redirect to login if no token
    if (!token) {
      window.location.href = "FT-auth.page.html";
    }

    // Helper function for authenticated requests
    async function apiRequest(url, options = {}) {
      const headers = { ...options.headers };
      if (token) headers["Authorization"] = `Bearer ${token}`;
      if (options.body && typeof options.body === "object" && !(options.body instanceof FormData)) {
        headers["Content-Type"] = "application/json";
        options.body = JSON.stringify(options.body);
      }
      const res = await fetch(url, { ...options, headers });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Request failed");
      return data;
    }

    // Email validation helper
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Disable/enable button with loading state
    function setButtonLoading(btn, isLoading, originalText) {
      if (isLoading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.textContent = "⏳ Processing...";
        btn.style.opacity = "0.7";
      } else {
        btn.disabled = false;
        btn.textContent = originalText || btn.dataset.originalText || btn.textContent;
        btn.style.opacity = "1";
      }
    }

    // ===== 0. PROFILE MANAGEMENT (STAGE 11) =====
    // Load profile on page load
    async function loadProfile() {
      try {
        const data = await apiRequest(`${API_ROOT}/admin/settings`);
        document.getElementById("profileEmail").value = data.email || "";
        document.getElementById("displayName").value = data.name || "";
      } catch (err) {
        console.warn("Could not load profile:", err.message);
      }
    }

    // Save profile
    document.getElementById("profileForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const email = document.getElementById("profileEmail").value.trim();
      const name = document.getElementById("displayName").value.trim();
      
      // Validation
      if (!email || !isValidEmail(email)) {
        alert("❌ Please enter a valid email!");
        return;
      }

      if (!name) {
        alert("❌ Please enter a display name!");
        return;
      }
      
      setButtonLoading(btn, true);
      
      try {
        await apiRequest(`${API_ROOT}/admin/settings`, {
          method: "PUT",
          body: { email, name }
        });
        alert("✅ Profile updated successfully!");
      } catch (err) {
        alert(`❌ ${err.message}`);
      } finally {
        setButtonLoading(btn, false, "Save Profile");
      }
    });

    // ===== 1. PASSWORD CHANGE =====
    document.getElementById("passwordForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const current = document.getElementById("currentPassword").value.trim();
      const newPass = document.getElementById("newPassword").value.trim();
      const confirm = document.getElementById("confirmPassword").value.trim();
      
      // Validation
      if (!current) {
        alert("❌ Please enter your current password!");
        return;
      }

      if (!newPass) {
        alert("❌ Please enter a new password!");
        return;
      }

      if (newPass.length < 6) {
        alert("❌ New password must be at least 6 characters!");
        return;
      }

      if (newPass !== confirm) {
        alert("❌ Passwords do not match!");
        return;
      }

      if (current === newPass) {
        alert("❌ New password must be different from current password!");
        return;
      }
      
      setButtonLoading(btn, true);
      
      try {
        // Get current profile data
        const profileData = await apiRequest(`${API_ROOT}/admin/settings`);
        
        // Update with password change
        await apiRequest(`${API_ROOT}/admin/settings`, {
          method: "PUT",
          body: { 
            name: profileData.name,
            email: profileData.email,
            currentPassword: current, 
            newPassword: newPass 
          }
        });
        alert("✅ Password updated successfully!");
        e.target.reset();
      } catch (err) {
        alert(`❌ ${err.message}`);
      } finally {
        setButtonLoading(btn, false, "Update Password");
      }
    });

    // ===== 2. BUSINESS INFO MANAGEMENT =====
    // Load business info on page load
    async function loadBusinessInfo() {
      try {
        const data = await apiRequest(`${API_ROOT}/settings/business`);
        document.getElementById("storeName").value = data.storeName || "";
        document.getElementById("contactEmail").value = data.contactEmail || "";
        document.getElementById("phone").value = data.phone || "";
        document.getElementById("address").value = data.address || "";
        document.getElementById("businessHours").value = data.businessHours || "";
      } catch (err) {
        console.warn("Could not load business info:", err.message);
        // Silent fail - settings may not exist yet (first time setup)
      }
    }

    // Save business info
    document.getElementById("businessForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      
      const storeName = document.getElementById("storeName").value.trim();
      const contactEmail = document.getElementById("contactEmail").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      const businessHours = document.getElementById("businessHours").value.trim();

      // Validation
      if (contactEmail && !isValidEmail(contactEmail)) {
        alert("❌ Please enter a valid email address!");
        return;
      }

      const businessData = {
        storeName,
        contactEmail,
        phone,
        address,
        businessHours
      };
      
      setButtonLoading(btn, true);
      
      try {
        await apiRequest(`${API_ROOT}/settings/business`, {
          method: "PUT",
          body: businessData
        });
        alert("✅ Business information saved successfully!");
      } catch (err) {
        alert(`❌ ${err.message}`);
      } finally {
        setButtonLoading(btn, false, "Save Business Info");
      }
    });

    // ===== 3. NOTIFICATION PREFERENCES =====
    let notificationSaveTimeout = null;

    // Load notification preferences
    async function loadNotifications() {
      try {
        const data = await apiRequest(`${API_ROOT}/settings/notifications`);
        document.getElementById("notifyOrders").checked = data.newOrders || false;
        document.getElementById("notifyLowStock").checked = data.lowStock || false;
        document.getElementById("notifyNewUsers").checked = data.newUsers || false;
      } catch (err) {
        console.warn("Could not load notification preferences:", err.message);
        // Silent fail - preferences may not exist yet
      }
    }

    // Save notification preferences (debounced)
    async function saveNotifications() {
      // Clear any pending save
      if (notificationSaveTimeout) {
        clearTimeout(notificationSaveTimeout);
      }

      // Debounce: wait 500ms after last toggle before saving
      notificationSaveTimeout = setTimeout(async () => {
        const prefs = {
          newOrders: document.getElementById("notifyOrders").checked,
          lowStock: document.getElementById("notifyLowStock").checked,
          newUsers: document.getElementById("notifyNewUsers").checked
        };
        
        try {
          await apiRequest(`${API_ROOT}/settings/notifications`, {
            method: "PUT",
            body: prefs
          });
          // Silent success - no need to alert for every toggle
          console.log("✅ Notification preferences saved");
        } catch (err) {
          console.error("Failed to save notification preferences:", err.message);
          alert(`❌ Failed to save preferences: ${err.message}`);
        }
      }, 500);
    }

    // Attach toggle listeners
    document.getElementById("notifyOrders")?.addEventListener("change", saveNotifications);
    document.getElementById("notifyLowStock")?.addEventListener("change", saveNotifications);
    document.getElementById("notifyNewUsers")?.addEventListener("change", saveNotifications);

    // ===== 4. DATA EXPORT =====
    // Generic export function
    async function exportData(endpoint, filename, btn) {
      const originalText = btn.textContent;
      setButtonLoading(btn, true);
      btn.textContent = "⏳ Exporting...";

      try {
        const headers = {};
        if (token) headers["Authorization"] = `Bearer ${token}`;
        const res = await fetch(`${API_ROOT}${endpoint}`, { headers });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ message: "Export failed" }));
          throw new Error(errorData.message || "Export failed");
        }
        
        const blob = await res.blob();
        
        // Check if blob is empty
        if (blob.size === 0) {
          throw new Error("No data to export");
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Show success feedback
        btn.textContent = "✅ Downloaded!";
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      } catch (err) {
        alert(`❌ ${err.message}`);
        btn.textContent = originalText;
      } finally {
        setButtonLoading(btn, false, originalText);
      }
    }

    // Export Products CSV
    document.getElementById("exportProducts")?.addEventListener("click", async function() {
      await exportData("/export/products", "products", this);
    });

    // Export Orders CSV
    document.getElementById("exportOrders")?.addEventListener("click", async function() {
      await exportData("/export/orders", "orders", this);
    });

    // Export Sales CSV
    document.getElementById("exportSales")?.addEventListener("click", async function() {
      await exportData("/export/sales", "sales", this);
    });

    // Profile form handler (placeholder - you can connect this later)
    document.getElementById("profileForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const email = document.getElementById("profileEmail").value.trim();
      const displayName = document.getElementById("displayName").value.trim();
      
      // Validation
      if (email && !isValidEmail(email)) {
        alert("❌ Please enter a valid email address!");
        return;
      }
      
      setButtonLoading(btn, true);
      
      // TODO: Connect to backend API when ready
      setTimeout(() => {
        alert("✅ Profile update coming soon! This feature will be connected to the backend.");
        console.log({ email, displayName });
        setButtonLoading(btn, false, "Save Profile");
      }, 500);
    });

    // Load data on page load
    document.addEventListener("DOMContentLoaded", async () => {
      // Load settings data
      await Promise.all([
        loadProfile(),
        loadBusinessInfo(),
        loadNotifications()
      ]);
      console.log("⚙️ Settings loaded");
    });
  </script>
</body>
</html>